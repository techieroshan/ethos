# Upstream server configurations for load balancing

# API Backend Upstream
upstream api_backends {
    # Load balancing method: least connections
    least_conn;

    # Backend servers
    server api-01:8000 weight=1 max_fails=3 fail_timeout=30s;
    server api-02:8000 weight=1 max_fails=3 fail_timeout=30s;
    server api-03:8000 weight=1 max_fails=3 fail_timeout=30s;

    # Health check (nginx plus only)
    # health_check interval=10s fails=3 passes=2;

    # Keepalive connections
    keepalive 32;
}

# Alternative upstream for blue-green deployments
upstream api_backends_blue {
    least_conn;
    server api-blue-01:8000 weight=1 max_fails=3 fail_timeout=30s;
    server api-blue-02:8000 weight=1 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream api_backends_green {
    least_conn;
    server api-green-01:8000 weight=1 max_fails=3 fail_timeout=30s;
    server api-green-02:8000 weight=1 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# Frontend Upstream (for SSR or multiple frontend instances)
upstream frontend_backends {
    ip_hash;  # Session stickiness for frontend
    server frontend-01:3000 weight=1 max_fails=3 fail_timeout=30s;
    server frontend-02:3000 weight=1 max_fails=3 fail_timeout=30s;
    keepalive 16;
}

# Static Assets Upstream (CDN-like distribution)
upstream static_backends {
    hash $request_uri consistent;
    server static-01:3000 weight=1 max_fails=3 fail_timeout=30s;
    server static-02:3000 weight=1 max_fails=3 fail_timeout=30s;
    server static-03:3000 weight=1 max_fails=3 fail_timeout=30s;
}

# Database proxy upstream (for read replicas)
upstream db_read_replicas {
    least_conn;
    server postgres-read-01:5432 weight=2 max_fails=3 fail_timeout=30s;
    server postgres-read-02:5432 weight=2 max_fails=3 fail_timeout=30s;
    server postgres-read-03:5432 weight=1 max_fails=3 fail_timeout=30s;  # Lower weight for backup
}

# Redis cluster upstream
upstream redis_cluster {
    # Redis doesn't support HTTP, but this shows the concept
    # In practice, you'd configure Redis clients to connect to multiple nodes
    server redis-01:6379;
    server redis-02:6379;
    server redis-03:6379;
}
